name: build binaries

on:
  pull_request:

jobs:
  build-binaries:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        folder: ["caxa"]
        include:
          - os: ubuntu-latest
            platform: linux
            ext: ""
          - os: macos-latest
            platform: macos
            ext: ".tar.gz"
          - os: windows-latest
            platform: windows
            ext: .exe
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: volta-cli/action@v1
      - run: npm ci
        working-directory: ${{ matrix.folder }}
      - run: npm run build
        working-directory: ${{ matrix.folder }}
      - name: setup the certs (on macos)
        if: ${{ matrix.platform == 'macos' }}
        working-directory: codesigning
        run: |
          bundle install
          bundle exec fastlane match development
        env:
          GITHUB_TOKEN: ${{ secrets.FRONTSIDEJACK_GITHUB_TOKEN }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }} # TODO
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          APP_STORE_CONNECT_API_KEY_IN_HOUSE: false
      - name: sign the binary (on macos)
        if: ${{ matrix.platform == 'macos' }}
        run: |
          codesign -s "The Frontside Software, Inc." ${{ matrix.folder }}/dist/file-interactor.app
      - name: tar the binary for upload (on macos)
        if: ${{ matrix.platform == 'macos' }}
        shell: bash
        run: |
          gtar -C ${{ matrix.folder }}/dist -cvzf ${{ matrix.folder }}/dist/file-interactor.tar.gz file-interactor.app
      - uses: actions/upload-artifact@v2
        with:
          name: file-interactor-${{ matrix.platform }}-${{ needs.version-or-release.outputs.version-binary-testbed-caxa }}${{ matrix.ext }}
          path: ${{ matrix.folder }}/dist/file-interactor${{ matrix.ext }}
